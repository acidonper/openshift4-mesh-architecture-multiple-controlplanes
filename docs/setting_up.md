# Setting Up Red Hat Service Mesh Multiple Control Planes Architecture

This document tries to collect a set of procedures to deploy and configure multiple control planes based Red Hat Service Mesh solution.


## Install Red Hat Service Mesh Operators

Before starting the deployment process, it is time to install the required operators in order to deploy de Red Hat Service Mesh solution.

Execute the following procedure to generate the respective certificate.

- Install operators

```$bash
sh resources/scripts/00-deploy-mesh-operators.sh
```

- Review operators pods

```$bash
oc get pods -n openshift-operators

NAME                               READY   STATUS    RESTARTS   AGE
...
istio-node-xwr45                   4/4     Running   0          22h
istio-operator-59cd777cc5-rpf7k    1/1     Running   0          35s
jaeger-operator-698bd8554c-9f5cn   2/2     Running   0          33s
kiali-operator-d8ffdcf8d-jzrfs     1/1     Running   0          44s
```

## Create CA certificates

It is required to generate a CA certificate in order to have a common CA for all the certificates generated by the service mesh.

Execute the following procedure to generate the respective certificate.

- Execute the command and introduce the respective information

```$bash
sh resources/scripts/01-generate-ca-cert.sh

Generating RSA private key, 2048 bit long modulus (2 primes)
..................+++++
.+++++
e is 65537 (0x010001)
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:ES
...

ls resources/certs 

ca-cert.pem  ca-key.pem
```

## Install Service Mesh Control Planes

Once the operators are installed and the certificates created, it is time to deploy the multiple control planes with the same CA certificate.

Execute the following procedure to install the respective control planes.

- Install the control planes

```$bash
sh resources/scripts/02-deploy-controlplanes.sh
```

- Review pods 

```$bash
oc get smcp -A
NAMESPACE       NAME            READY   STATUS            PROFILES      VERSION   AGE
mesh-egress     mesh-egress     10/10   ComponentsReady   ["default"]   2.1.1     17m
mesh-ingress    mesh-ingress    10/10   ComponentsReady   ["default"]   2.1.1     22m
mesh-workload   mesh-workload   10/10   ComponentsReady   ["default"]   2.1.1     8m2s
```

## Deploy _Jump App_ Solution

In order to test the global solution, it is required to deploy an application and integrate it into the service mesh. Execute the following procedure to deploy this application and configure all service mesh objects to be able external traffic and internal traffic work correctly.

- Include the required domain for deploying _Jump App_

```$bash
sed 's/apps.test.sandbox1196.opentlc.com/<openshift_apps_domain>/g' -i resources/control_planes/workload/jump-app.yaml
```

- Deploy _Jump App_ in the respective namespace

```$bash
oc project jump-app-dev
oc apply -f resources/control_planes/workload/jump-app.yaml
```

- Verify objects created in Openshift

```$bash
oc get all -n jump-app-dev
NAME                                       READY   STATUS    RESTARTS   AGE
pod/back-golang-v1-6d57d5cc57-rpwcq        2/2     Running   0          48s
pod/back-python-v1-76fd9495c5-kcffs        2/2     Running   0          48s
pod/back-quarkus-v1-75d65c4b7f-wzdsc       2/2     Running   0          47s
pod/back-springboot-v1-5f6cc67c8f-v44wq    2/2     Running   0          47s
pod/front-javascript-v1-5bf77b8899-s7d6t   2/2     Running   0          47s
...
```

- Test application deployed

```$bash
oc exec back-golang-v1-6d57d5cc57-rpwcq -c back-golang-v1 -- curl -XPOST -H "Content-type: application/json" -d '{
    "message": "Hello",
    "last_path": "/jump",
    "jump_path": "/jump",
    "jumps": [
        "http://back-golang:8442",
        "http://back-springboot:8443",
        "http://back-python:8444",
        "http://back-quarkus:8445"
    ]
}' 'localhost:8442/jump'

....
{"code":200,"message":"/jump - Greetings from Quarkus!"}

```



## Author

Asier Cidon @RedHat

