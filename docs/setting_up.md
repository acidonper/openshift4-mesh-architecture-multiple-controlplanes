# Setting Up Red Hat Service Mesh Multiple Control Planes Architecture

This document tries to collect a set of procedures to deploy and configure multiple control planes based Red Hat Service Mesh solution.


## Install Red Hat Service Mesh Operators

Before starting the deployment process, it is time to install the required operators in order to deploy de Red Hat Service Mesh solution.

Execute the following procedure to generate the respective certificate.

- Install operators

```$bash
sh resources/scripts/00-deploy-mesh-operators.sh
```

- Review operators pods

```$bash
oc get pods -n openshift-operators

NAME                               READY   STATUS    RESTARTS   AGE
...
istio-node-xwr45                   4/4     Running   0          22h
istio-operator-59cd777cc5-rpf7k    1/1     Running   0          35s
jaeger-operator-698bd8554c-9f5cn   2/2     Running   0          33s
kiali-operator-d8ffdcf8d-jzrfs     1/1     Running   0          44s
```

## Create CA certificates

It is required to generate a CA certificate in order to have a common CA for all the certificates generated by the service mesh.

Execute the following procedure to generate the respective certificate.

- Execute the command and introduce the respective information

```$bash
sh resources/scripts/01-generate-ca-cert.sh

Generating RSA private key, 2048 bit long modulus (2 primes)
..................+++++
.+++++
e is 65537 (0x010001)
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:ES
...

ls resources/certs 

ca-cert.pem  ca-key.pem
```

## Install Service Mesh Control Planes

Once the operators are installed and the certificates created, it is time to deploy the multiple control planes with the same CA certificate.

Execute the following procedure to install the respective control planes.

- Install the control planes

```$bash
sh resources/scripts/02-deploy-controlplanes.sh
```

- Review pods 

```$bash
oc get smcp -A
NAMESPACE       NAME            READY   STATUS            PROFILES      VERSION   AGE
mesh-egress     mesh-egress     10/10   ComponentsReady   ["default"]   2.1.1     17m
mesh-ingress    mesh-ingress    10/10   ComponentsReady   ["default"]   2.1.1     22m
mesh-workload   mesh-workload   10/10   ComponentsReady   ["default"]   2.1.1     8m2s
```

## Configure Service Mesh and Deploy the Final Application

Regarding the application, _Jump App_ is a microservice-based application designed to emulate an enterprise application complex architecture with multiple components written in different programming languages. This app allows users to configure a set of "jumps" between components in order to generate a continuous traffic flow between the microservices selected. Using the application Frontend written in Javascript, it is possible also define the number of retries and their span of time.

During the following sections, the Red Hat Service Mesh solution and the application will be configured in different modes in order to allow ingress, internal, and egress traffic through the mesh solution based on multiple control planes.

### Deploy _Jump App_ Solution (Internal HTTP)

This section includes the procedure and resources required to deploy _Jump App_ application and implement a service mesh solution based on HTTP connection between the component into the mesh. 

The idea behind this model is to enable HTTPs external connections, the final user will use secure connections to access the cluster, but maintaining internal HTTP connection between the different components deployed in the mesh. This implementation is useful in environments where it is not required to implement a high security level inside the cluster and a high performance solution in terms of communication is required.

Please visit [Deploy HTTP Mesh Solution document](./mesh_http.md) for more information about deploying Red Hat Service Mesh behind this model.

## Deploy _Jump App_ Solution (Internal mTLS)

WIP

## Author

Asier Cidon @RedHat

